using System;
using System.Collections.Generic;
using System.Linq;

namespace AdventOfCode
{
    class Day20
    {
        public static int Part2(string algo, char[][] image)
        {
            for (int i = 0; i < 50; i++)
            {
                image = Enhance(algo, image, i%2 == 1 && algo[0] == '#' ? 1 : 0);
            }
            return image.SelectMany(t => t).Sum(c => c == '#' ? 1 : 0);
        }

        public static int Part1(string algo, char[][] image)
        {
            image = Enhance(algo, image, 0);
            image = Enhance(algo, image, algo[0] == '#' ? 1 : 0);
            return image.SelectMany(t => t).Sum(c => c == '#' ? 1 : 0);
        }

        private static char[][] Enhance(string algo, char[][] image, int infinityValue)
        {
            var result = new char[image.Length + 2][];
            for (int i = 0; i < result.Length; i++) result[i] = new char[image[0].Length + 2];

            for (int i = 0; i < result.Length; i++)
            {
                for (int j = 0; j < result[0].Length; j++)
                {
                    int code = 0;
                    for (int di = -1; di <= 1; di++)
                    {
                        for (int dj = -1; dj <= 1; dj++)
                        {
                            if (i + di < 1 || i + di > image.Length || j + dj < 1 || j + dj > image[0].Length)
                                code = (code << 1) + infinityValue;
                            else
                                code = (code << 1) + (image[i + di - 1][j + dj - 1] == '#' ? 1 : 0);
                        }
                    }
                    result[i][j] = algo[code];
                }
            }
            return result;
        }

        public static readonly string Algo = @"##..####..###.#.#.#.#..######.#..#....##....###.........###....###.#########.#####..##..#.#.#..###..#..##.##...###.###.#.##.####..#.##.#.##.##.##.####....#.##...##.####.#...........#.#..#.##..#....#.###.###.#.##.#..###.#...#.#.....#####.####.####.##...#.#....#.#.#.###.#.##.##.#.####..#####.##..#.#.#..#....##..#.###....#..#.###...#...#...##.......#.#..#..#.#....#..#.#.###.##....#..#..##.#..###...#.######..#.##..#.#.#.###.###..##.#......#.#.##.....##..#.###.#.##..#.###########.......###.#..#..####...#.#.#.##.";

        public static readonly char[][] Image = @"####.###.##.#..###...#..###..#....##.##.##.#.#.#.#.#####.##...#.#.##...#.#######.#.##..#..#..#..###.
..#..#.#.##.#...###.####....##.#...###..########.###....##...#..#.###.######.......#.#.#..#.....#...
.####.#...#....#..#..#..##.......#.#.....###...####.#...#.....#...######...###..##.##.#.####.#...##.
.#.#.##.##.##.##..##....##.##..#.##.#.##.#......#..###..#...##.##.######.#.#.##.#..#..#.#####..#.#..
....#....#...#.#####..#...##.#...##..#......#....####.##..##.##..#.#.#.###.#..#.##.........###...###
.#..###.########....#.###...#.##.####.#.#.#####.....#.#.#.#####..#####.......##..#.###....#...###..#
....#.####.#.###..#.#.#...####.##.###..#..###.###....#####...#.##..###.#######.##..##.#.###...##...#
.#..#.#.#.#..#.........#.#.#.#..##.####....#..#......#.##...###........#.....#..#..##.#...#.#...###.
#.#.###.#..#...##.#.#..#....#..#...#....#######.#.##.#########..#.##....#.#....##.#...##...###....##
.###.#.##..#..###.#.##......####..##..#####.##..#...#.##.###.#...#.###.##.#.#.....###############...
....#.....#..#####.##...###..#..#..##..##.###....####....####.#.##.#.#.###...#.#....#####...###.#.#.
...##...#.#...#....#.##.####.#.#.#.#...###...#.#..##..###..###....#..#####....#.#..##..###..####.#.#
######.#..##.##..#.#..#.#...####...##..##...#...#..#..##.#####..#####.##......##.##...#.#..#.###....
.#####.#..#######.####.#.#...##...#.####.#.##..###.#.#..####..##.####....##..#####.#.#.#.#.#...#...#
#.#..#..#..###..#...#.#....##.###..###..##..###...#....###.##.##..####...###.##..#.####.#.#..##...##
.#.##.#.#...#.####...#....#..#######.###.......#.#...#..#####.##.#.##...###...#..#..##.#..#.###..###
#..#...#####..####..#...#...##..#....#......#.....#.#..#..#..####.##....#..###......#....###.#.###.#
.###....#.#.#.#.##..#.#.##.#.#.#..####.####.....##...##.#..#..#...#..###....#.###..####.#....#.#...#
#####.#.##....#.#...#####.####.##..##..#.##....####..#.#...#....###.#..##.#...####.#.##.##.###......
##.###.#..#.#.##.##.#.###.#..#..#.#.##........#.....#.#..###......#..#.##.#..#..##.####.##....#....#
#.##.#.##........####...#####...#####.......###..##.####..##.#.#.##.####..#..#.##..###..##.##...##.#
.#.###...#..###..#.#.....#####....##..##.##.##.##..#.#..####.....##.#.#..###.....####.#.#..#..##.###
#....#.##.#.###..####.###.#.....#.#..#.#.###..#.#......####.##..#######..#.#.##..##.##...#.#.###..##
.#...##...#####...###...#####.#####.#.##....###..#.#.#..#.#..#.####..####.#.##...#.########..#..#.#.
##.#..##.##.##..####.##...#..#....#.#..##.###..##..###..#.######..##..###.#...##.#####.#.###.#######
####.####....####......###...#.####..###....##.....###.#######..#..###..#..####.#....#..##.##..#.#.#
#..##.#.#.#..#..##.#.....##..#.##...##...#..##..#..###.#.......###.##.###..##.#.####.#..#####.#.##..
..###...##.#.#....#....###..##.####.#.##.#.##.#.##..#.######..#.#.##..####.##.#.###.......##..##...#
.#.###.##....#...##.#.#.#####..######.#...#...####.....##.##....##.##..#..#..##...#.##.#.#..##.###..
..######.#..#.##.##.####.#######....#.#..#.#.#.....#.#...#.#..#.#..##.#.....##.##.#.##..#.....#..#..
###.#..##############.#.###.##...#.#..##..#.#.#..##.######.##...##....##..###..###...#..#.##..#.##..
#...#.#..##........###.#...##.#....#...##....###.########..###.##.#..#.#..#..###......#.#.#....#.#..
#.#..#..#.#..#######.....#....######..##..#.....#.#..##.#.###.#.###..#.#.#..##..#.#.#.....#.#.##.#.#
....#...#.#####.#.##.###.##..#.##..#.#.##########..#.###..#...#####..#.#.###..###.##.#.....######.#.
###..#####..####..#..##.###...#...#..#.#.......##.#.#.####.##..#.......##...####.....##....#..#.##..
..#.#..#.###.##...##.#.##..##.###.#.##...###.##.##.#.....#.#..##.##..###.##...#.#.##...##.####......
.##.##..#....###..#.#..#.##..#...#.#.##.##..###.##.##...#.....#.#.##..#..##..##.###.##.##.......#.#.
##..#.###.###..####.###...#########.##.##..#....#.#..#...#..###.##..#..#####..#####...#.##.#####.#..
##...#.#.###.###..#..##.#...##..########..##..#..#...####.#..###....#.#.####...##.##..##.#....###...
..#...####.....#.##.###....#.##.#.#.###.#.#.##....#..#.#..#..######..#.##...###...#.##.#..#.#.....##
.#..###....#....#..#.#....#...#.#.#...##..#...###.###.#..##...#..#.###.#..####.###...#...........##.
#......#..#...##.#####.#.....###.##..##...##.#.#..#....#..#.#...#.####.#.####.####.##.#..##.##.#.#.#
#..#.#..#.#.##.#####.#.#####..###..####...#...######.##.#.#.###.#.#.#.###.#####.##.##..#....#..#..##
#....###.####..###.##..#####.....#..#....#.##..##....###..#.....##...##.##..#.###.#...##..#.#..#.#..
.#....###.#.#####.....##.....#.#.#.......#####..###........##..##..###.###..###...#.#.#..###....#.#.
.##..#..##..#..##...##.#.###..##..##########.#.###...##..##..#.#..#..#.##.#......#.......#.##..##.##
##.#...#.#.####..#.#..##.##.##....#..#...#....##...#..#......#..##...#...#.#....####.#.##.##.#....#.
..#....#.#.#.##......###.###.###.###.###.....#..###..#..##.#..#.#...#..#..#..########..#.#...###.#.#
..#..###.#.#..##..#.#.##....#.###....##...#..#####..###..#..#####.#...####.###.##.#...###..##.###...
##..#########..##.####....#.####...###..#.#.###..#.###..#....#..####.#...#.#.##.#...#.##..#.##.###..
..#...#.####..####.#...#.##..#...###...###.#.#..#....##.##...###..#.#######.##.#..#.###.#..#.....#..
###.###.....#####.##.#.####.##..##.##....#......#.##..##...#.##.######.####..#..####.#..##.##.##..#.
#.#..#..##....##.#.#.##.##.##...#..#....###...###..##..##....###..#..###.##....##...#.....#.#######.
#######...#.####.#.####.#..#......##...###..#.###..#..#..#####.##...#..###....#.###....#..###..#...#
.##.##.#......#..#...##.....###..#.....##.###.#..##...#....#..########.#.##...#.##..##.#.######.##.#
######....#....#...##..#..#.#...#.##.#.###..#.###.#.###.##..####..###..#.##.#.....##.#....######....
#.###.##..#.#.#####.####..#.#.#######.###....##...###........#..###.#.###.###.#####..###..#....#.##.
.####...#..##..#..###.####.###.##...#.###..#.#.#.........#.#.#..#.#....#.##....#..#..###....#.....#.
#.##.#.######.##.###.#..##...#.###.#.##..##...##.##.#...#.##.#.#...#...#####..#####.#.##.#.#.###.#.#
##.##.#.##...##.###.###..#...#.####......##..#...#.##.....#.####......##....#..##..#..#.##..##...#..
.#.##.###.##.##..##.#...#.#..#####...#.#...#.#####.##.#.#.##...#.#.##.#......#.#.#...##.#.#...#.##.#
.##.......##..#...##.####.###.##...##..#...#.#..###...#####..#..#......#......#.....#...#..#.##.###.
..#.#..#..##......#..###..###..##...##.#.......##..###.#...#.###..###..#.#.##..##.##...##.#...###...
#.####.##.#...#.#.#####.#.###.....#.#..#...##...#..##...###.####.##.#..#...#...#.###.#...#.#.##.#.#.
..#..#.#..#.##..#....##........##.######......#.#.##.##..#...##....#.#..##.#......##..#####....#.##.
..#.#####.#..##........#.#...###..###......##.####......#.....#####...#..#.#.#######....##.#####..##
###.#...####...#.....##.#.#.....##.##.##.#...###.#....##...##.#...#..#.....#.#.##..#.....#..#.##...#
#..#..##.##..#..#.#.#...##..###..#.#######.....####...###.....######.##.##.#.#.#####.##...##..###.##
#######.#.#..#.....##.#...#.####.##.#.#.##..#..#.#..###.#.#.#.##.#..###.#.....#.#..##....#...#.#.#..
.##.#.##.#...###.###......####..##.#..#.#.##...####..#..#..#..#...###..#.#.#.##.####..#.#.####.#.#.#
####.#.....##....##.#..##..##.#.#.#.#.#..##.#...#.########..#.##.#.#.#..##.#.##.#...#.#..######.#..#
#.#.#######...#####.##.#.####..#####.#...####.#.#..#...#....##.##.##......##.#.##..####......#...#..
##..###.####.##..#...####...#.##...#.##.#..#..##.#.#..##.#......##.##...#......######...#...##....##
#.###..#.....##..##.#.###..#....##.##.##...##.#.#.#..##.#....####..#..#####..####.#...#..#.##...#...
.#......#...##.##...####.##.#..####.#.#.#..#...###....##.#.###.##..#.#.#..#..#.##...#.##.......#...#
.#...#####.#####...#.##.###.....#....#...####.##...#..##.##..#.##...#.##....#..##..#...###.####..#.#
..#......#.#..#....#...#.#...##.#####.##.##..#.##.#.##.#...##.##....#.###...###..#.#...######..##..#
..####..#....#..###.#..#.##.#..##.#...#..##.####.###..#..#.#....#.....##.#.##..####.#.###..##.#.###.
.#....##.###.#..#..#.#..#...##...###.#..#.##...#...##.###.......##....##....###..##..##.##..#....#.#
##..###...#...##..#...####.#.......#..#######..#..######..###.####..#.##..########.##..#.#..##..####
#..##.##.#.###.###.#...#...####..####.##.#.#.###..##..##...#..##.#..####...#.##..#..#.#...#..####.#.
...##..#..#.##.#..##.###.....####..####.#######.##.##.##.#...##.#.#.##..#.##.####..#....#..########.
#...#.#..##.#...###.#####...#.###...##.#.#.##...#.....##.#.##.#.###.#...#.##......#...###.#..###.#.#
##.##...##...#..#..##.##.##.#....####...#..#.#..#...#........#.#.#####.#....##.#...#####.....###...#
..##.##.##.#.#..#.#...#..##..####.#.###..#..###.##.##...####.#.####.##....#.#.####.#.####.#........#
.###...#.####.##.#.#.#..#.##.###.#.#......#######..##.#.#...#...###..#.#...##.##.###.#..###.....#..#
.#...####.#.#...#.##.#...#.#...#.#.###...#..###.#...#..##.#....####......###.##..##..#...#.....#.##.
#..#.##.#.##.#.##.#..#.#.#.##.#.####.#...###..#.###.###.#..##.##.#....#..##.#.###.#.#..####.#.#.##.#
.#..#.######.#....#...###.##.#.###..#.##.##.#####...##..#....#.####...#..####..##.#..#.##.#.###.####
#.#..#.##..#.#.#...#.#.###.#......#.#.......##..#.....####.#......#.####..##..#..#...#.####.#.##....
##.##.....##.#....###...###.#...##...#.##..##.##...#.#.....##.##.##.#..###..#.###..###....#.####..##
#..#.#..#...#.####.#.##...#..####.#.....#.##.#...####.##.########.#.#.##..###.##.....#.#..##..#.##.#
#..##.#.###..#.###...########....#..####.##....#..##...#..#.....####..##.#######.....####.###..#.###
..#.####..#.#.#.#####..##.########..#..#.#.##...##.#.##.#.#.##..##...#.#...#..#....#..##.#.#######.#
#.####.##..##.##.#.#.#.##.##..#.##..#...#..##....###.#...#....##.#..#..#.##.#...##.#..#...#.#....#.#
.###########.#..#..###....#.#.#.####.#.#..####....##.#.##.####....##..#.####..#...##.#......#.##.###
..##..##.#.#..#....#.#.#####..###..##.#..##.##..##..####...#...##.#####....#...#.#####.....#...##...
#.######.##.......##...##...#.#..#.##..#.##.#####.#.##....##.#####.##....#....#..####.###.#.#.....##
#.#.###..#.##########...#...#..#.##...#.##.##..####.######...#..##.##.....#.#...#..###.####....#.##.
....#..#...##..#.##.#..#.###...###..##.##......#..##..##...##.#.######.#..#.#.###.##.###.#..#..#####".Split(Environment.NewLine).Select(l => l.ToCharArray()).ToArray();
    }
}
